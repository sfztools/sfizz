<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Home - Sfizz</title>
		<meta name="author" content="Paul Ferrand">
		<meta name="web-author" content="RedTide">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- Atom Feeds -->
		<link href="./../atom.xml" rel="alternate" title="News"
			type="application/atom+xml" />
		<!-- Favicon Generator Icons -->
		<link rel="apple-touch-icon" sizes="180x180"
			href="./../assets/ico/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="./../assets/ico/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="./../assets/ico/favicon-16x16.png">
		<link rel="manifest" href="./../assets/ico/site.webmanifest">
		<link rel="mask-icon" href="./../assets/ico/safari-pinned-tab.svg"
			color="#5bbad5">
		<link rel="shortcut icon" href="./../assets/ico/favicon.ico">
		<meta name="msapplication-TileColor"
			content="#da532c">
		<meta name="msapplication-config" content="./../assets/ico/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
		<!-- Stylesheets -->
		<link href="./../assets/css/style.min.css"
			rel="stylesheet" media="screen">
		<!-- Font Awesome Icons -->
		<script src="https://kit.fontawesome.com/8d25d19870.js"></script>
	</head>
	<body>
        <div class="container">
		<button onclick="topFunction()" id="scrollButton" title="Go to top">Top</button>
		<a href="#content" class="sr-only">Skip to content</a>
			<nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#222">
				<a class="navbar-brand" href="./../"><img src="./../assets/img/logo.png"
                    width="30" height="30" class="d-inline-block">Sfizz</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse"
					data-target="#navbarContent" aria-controls="navbarContent"
					aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarContent">
					<ul class="navbar-nav mr-auto mt-2 mt-lg-0">
						<li class="nav-item">
							<a class="nav-link" href="./../status"><i class="fas fa-tasks fa-fw"
									aria-hidden="true"></i>&nbsp;Status</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="./../downloads"><i class="fas fa-download fa-fw"
									aria-hidden="true"></i>&nbsp;Downloads</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="./../contacts"><i class="fas fa-at fa-fw"
									aria-hidden="true"></i>&nbsp;Contacts</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="https://sfztools.github.io/"><i class="fas fa-home fa-fw"
									aria-hidden="true"></i>&nbsp;Home</a>
						</li>
					</ul>
				</div>
			</nav>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Global view of the engine </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The sfizz engine is basically a "Synth" object that takes an SFZ file in, receives MIDI-type events and is able to render audio through successive calls to a callback function. This is in line with the way most audio applications and plugins are working. A high-level overview is presented in the following diagram.</p>
<div class="fragment"><div class="line">                                      C and C++ API entry point</div><div class="line"></div><div class="line">                                                  |</div><div class="line">                                                  |</div><div class="line">                                                  |</div><div class="line">                                                  |</div><div class="line">                                         +--------v-------+</div><div class="line">                                         |                |</div><div class="line">               +--------------------------     Synth      -----------------------------+</div><div class="line">               |                         |                |                            |</div><div class="line">               |                         +----------------+                            |</div><div class="line">               |                                  |                                    |</div><div class="line">      +--------v------+                           |                          +---------v--------+</div><div class="line">      |               |                 +---------v---------+                |                  |</div><div class="line">      |  Region list  |                 | Common resources  |                |    Voice pool    |</div><div class="line">      |               |                 |     and state     |                |                  |</div><div class="line">      +---------------+                 | ----------------- |                +------------------+</div><div class="line">   Built from the SFZ file              |  File pool        |</div><div class="line">                                        |  Envelope pool    |            The voices are the polyphony</div><div class="line">Each region is a semi-passive           |  LFO pool         |            of the synth. They are idle</div><div class="line">description object that can             |  Buffer pool      |            and they get activated by the</div><div class="line">decide whether it is &quot;active&quot;           |  Midi state       |            synth to play a region on a</div><div class="line">or not depending on the chain           |  ...              |            specific event. They are then</div><div class="line">of MIDI events it receives.             +-------------------+            &quot;linked&quot; to the region while</div><div class="line">Once activated, a voice is         There are a number of common          it is played, and reset to</div><div class="line">chosen to play the region until    resources that are needed for         their idle state when they</div><div class="line">it ends naturally or through       all the regions and in parti-         are done playing the region.</div><div class="line">note-offs or off-groups.           cular the voices. This includes</div><div class="line">                                   all the (preloaded) files for</div><div class="line">                                   the SFZ instrument, but will</div><div class="line">                                   include in the future the EG</div><div class="line">                                   and LFOs that are needed to</div><div class="line">                                   achieve compliance with the</div><div class="line">                                   SFZ v2 specification. This will</div><div class="line">                                   also include a temporary buffer</div><div class="line">                                   holder that voices may share.</div><div class="line">                                   A common resource of importance</div><div class="line">                                   is the MIDI state: note durations</div><div class="line">                                   are needed for some opcodes --</div><div class="line">                                   for example rt_decay -- and</div><div class="line">                                   triggering velocities too.</div></div><!-- fragment --><p>The Synth, Voices and Regions form the bulk of the code complexity. The rest of the engine is dedicated of mostly helper classes to enable easy management of floating-point buffers in which the audio data is held, signal processing and accelerated (SIMD) computations, and abstractions that are specific to the SFZ format such as envelope generators, curves or LFOs.</p>
<h1>Parsing the SFZ files</h1>
<p>The sfz file logic is pretty simple and well defined. The sfzformat.com website contains an extensive documentation on it. At its core, an SFZ file describes a list of <code>region</code> objects on which a certain number of "opcodes" will apply. Opcodes can determine the sample played, the event conditions that will trigger the sample such as the range of notes, channels, velocities, the processing to apply on the sample while playing, and many more things. It is also possible to describe a <code>group</code> of regions, as well as exclusive groups that will shut off other regions that may already be playing. There are also <code>master</code> groups, and <code>global</code> opcodes and some other types.</p>
<p>All the opcodes are declared within a header, in a pseudo-xml markup language that looks like this </p><div class="fragment"><div class="line">&lt;global&gt; volume=6</div><div class="line">&lt;control&gt; set_cc4=5</div><div class="line">&lt;region&gt; key=36 sample=kick.wav</div></div><!-- fragment --><p> Here we have 3 headers (<code>global</code>, <code>control</code> and <code>region</code>) and each header holds some opcodes. All of these opcodes have a value&mdash;for example the volume is equal to 6 in the <code>global</code> header. Some opcodes also have parameters. The <code>control</code> header holds an opcode <code>set_cc</code> with the parameter <code>4</code> and value <code>5</code>. The parameter here is the CC to set, and the value at which to set it is 5.</p>
<p>The parsing logic of sfizz is handled through a base class called Parser&mdash;a very original choice. This parser has a virtual callback that gets called whenever a header description is "complete", along with a list of opcodes that apply to the header. Subclassing the Parser then allows to build different SFZ handlers, from full-blown synths as with sfizz to simpler things such as printers (see in particular <a href="https://github.com/sfztools/sfz-flat/">https://github.com/sfztools/sfz-flat/</a>). If we look at the core of the latter example, it will look something like the following</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>PrintingParser: <span class="keyword">public</span> sfz::Parser</div><div class="line">{</div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="keywordtype">void</span> callback(absl::string_view header, <span class="keyword">const</span> std::vector&lt;sfz::Opcode&gt;&amp; members) <span class="keyword">final</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">switch</span> (<a class="code" href="_string_view_helpers_8h.html#a0d70224bb798d5b61584ca93597224a6">hash</a>(header)) <span class="comment">// The hash(...) function transforms strings to large integers</span></div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="_string_view_helpers_8h.html#a0d70224bb798d5b61584ca93597224a6">hash</a>(<span class="stringliteral">&quot;global&quot;</span>): <span class="comment">// It is also compile-time defined, which allows to do switch-case</span></div><div class="line">                             <span class="comment">// statements on strings, something that is usually not possible</span></div><div class="line">            globalMembers = members; <span class="comment">// We save the global headers since they apply to the next</span></div><div class="line">                                     <span class="comment">// region (and groups and masters)</span></div><div class="line">            masterMembers.clear();</div><div class="line">            groupMembers.clear();</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="_string_view_helpers_8h.html#a0d70224bb798d5b61584ca93597224a6">hash</a>(<span class="stringliteral">&quot;master&quot;</span>):</div><div class="line">            masterMembers = members; <span class="comment">// So on</span></div><div class="line">            groupMembers.clear();</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="_string_view_helpers_8h.html#a0d70224bb798d5b61584ca93597224a6">hash</a>(<span class="stringliteral">&quot;group&quot;</span>):</div><div class="line">            groupMembers = members; <span class="comment">// .. and so forth</span></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="_string_view_helpers_8h.html#a0d70224bb798d5b61584ca93597224a6">hash</a>(<span class="stringliteral">&quot;region&quot;</span>):</div><div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;&lt;&quot;</span> &lt;&lt; header &lt;&lt; <span class="stringliteral">&quot;&gt;&quot;</span> &lt;&lt; <span class="stringliteral">&#39; &#39;</span>; <span class="comment">// Now we print the region along with all the opcodes</span></div><div class="line">                                                      <span class="comment">// we memorized from earlier headers.</span></div><div class="line">            printMembers(globalMembers);</div><div class="line">            printMembers(masterMembers);</div><div class="line">            printMembers(groupMembers);</div><div class="line">            printMembers(members);</div><div class="line">            std::cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;&lt;&quot;</span> &lt;&lt; header &lt;&lt; <span class="stringliteral">&quot;&gt;&quot;</span> &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div><div class="line">            printMembers(members);</div><div class="line">            std::cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    std::vector&lt;sfz::Opcode&gt; globalMembers;</div><div class="line">    std::vector&lt;sfz::Opcode&gt; masterMembers;</div><div class="line">    std::vector&lt;sfz::Opcode&gt; groupMembers;</div><div class="line">    <span class="keywordtype">void</span> printMembers(<span class="keyword">const</span> std::vector&lt;sfz::Opcode&gt;&amp; members)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; member: members)</div><div class="line">        {</div><div class="line">            std::cout &lt;&lt; member.opcode;</div><div class="line">            <span class="keywordflow">if</span> (member.parameter)</div><div class="line">                std::cout &lt;&lt; +*member.parameter;</div><div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;=&quot;</span> &lt;&lt; member.value;</div><div class="line">            std::cout &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">};</div></div><!-- fragment --><p>The main function is then quite straightforward and we call a function from the Parser class that loads a file </p><div class="fragment"><div class="line">PrintingParser parser;</div><div class="line">parser.loadSfzFile(<span class="stringliteral">&quot;my_sfz_file.sfz&quot;</span>);</div></div><!-- fragment --><p> If you circle back to the parser you will see that opcodes are stored in an <code>Opcode</code> class. This class does some parsing itself and separates the opcode name itself, parameters if any, and the value. Opcodes are very cheap to copy and pass around because they only refer to characters in the file that are stored inside the <code>Parser</code> class, so feel free to create vectors of them and move them around.</p>
<p>Note that you may also derive the loadSfzFile method if you have any processing you need to do before the actual parsing happens.</p>
<h1>Building the region list in sfizz</h1>
<p>The callback method from sfizz is actually quite similar to the one shown above, except that instead of printing the region we actually fill a big structure from it. </p>
</div></div><!-- contents -->
			<hr>
			<footer>
				<p style="text-align:left">Copyright &copy; 2019 Paul Ferrand
					<span style="float:right">Generated for sfizz by
						<a href="http://www.doxygen.org/index.html"
							target="_new">Doxygen</a> 1.8.13</span>
				</p>
			</footer>
            </div>
		<script src="./../assets/js/scripts.min.js"></script>
	</body>
</html>
